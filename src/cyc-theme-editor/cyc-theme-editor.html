<link rel="import" href="../../bower_components/polymer/polymer-element.html">
<link rel="import" href="../../bower_components/polymer/lib/elements/dom-repeat.html">
<link rel="import" href="../../bower_components/kolor-picker/kolor-picker.html">
<link rel="import" href="../cyc-mixins/cyc-utils-mixin.html">

<dom-module id="cyc-theme-editor">
  <template>
    <link rel="stylesheet" href="cyc-theme-editor.css" inline>

    <form class="form" on-change="_enableSubmit" on-reset="_onFormReset" on-submit="_onFormSubmit">
      <h2 class="legend"><span>Editor Colors</span></h2>

      <ul class="group-list" on-mouseleave="_onListMouseleave">
        <template is="dom-repeat" items="[[_themeColors]]" id="editorColorsList">
          <li>
            <label class="color-field" on-mouseenter="_onColorHover">
              <span class="label">[[item.name]]</span>
              <kolor-picker
                alpha
                color="{{item.value}}"
                data-css-var$="[[item.cssVar]]"
                on-color-changed="_updateCSSVars"
                on-show="_setPickerOpened"></kolor-picker>
            </label>
          </li>
        </template>
      </ul>

      <div class="form-actions">
        <button class="btn btn--secondary" type="reset">It's awful!</button>
        <button class="btn btn--primary" type="submit" disabled="[[!_submitEnabled]]">Download theme</button>
        <a download="theme.json" id="downloadLink" hidden></a>
      </div>
    </form>
  </template>

  <script src="../../bower_components/tinycolor/tinycolor.js"></script>
  <script>
    {
      const { Element } = Polymer;
      const { UtilsMixin } = ColorYourCode;

      /**
      * `<cyc-theme-editor>` displays the full list of editor colors and
      * allows to change them and download the modified theme.
      * @polymer
      * @customElement
      * @memberof ColorYourCode
      * @appliesMixin ColorYourCode.UtilsMixin
      */
      class CycThemeEditor extends UtilsMixin(Element) {
        static get is() {
          return 'cyc-theme-editor';
        }

        static get properties() {
          return {
            // Type of the theme (dark|light).
            themeType: {
              type: String,
              value: 'dark',
            },
            // Name of the theme.
            themeName: {
              type: String,
              value: 'Your theme name',
            },
            // Object with the full theme configuration.
            theme: {
              type: Object,
            },
            _themeColors: {
              type: Array,
              computed: '_computeThemeColors(theme)',
            },
            _submitEnabled: {
              type: Boolean,
              value: false,
            }
          };
        }

        get _theme() {
          const type = this.themeType;
          const name = this.themeName;
          const colors = {};

          for (const color of this._themeColors) {
            colors[color.prop] = color.value;
          }

          return {type, name, colors};
        }

        _computeThemeColors(theme) {
          const colors = Object.entries(theme.colors);
          return colors.map(([key, value]) => ({
            name: key,
            prop: key,
            value: value,
            cssVar: this._toCSSVar(key),
          }));
        }

        _toCSSVar(value) {
          return `--${value.replace('.', '-')}`;
        }

        _setPickerOpened() {
          this._pickerOpened = true;
        }

        _updateCSSVars(e) {
          if (this._pickerOpened) {
            const {dataset: {cssVar}, color} = e.target;
            document.documentElement.style.setProperty(cssVar, color);
          }
        }

        _onFormReset(e) {
          e.preventDefault();
          this._submitEnabled = false;
          this._removeDocumentStyles();
          this._restoreOriginalTheme();
        }

        _removeDocumentStyles() {
          document.documentElement.removeAttribute('style');
        }

        _restoreOriginalTheme() {
          this.theme = Object.assign({}, this.theme);
        }

        _enableSubmit() {
          this._submitEnabled = true;
        }

        _onFormSubmit(e) {
          e.preventDefault();
          this._downloadTheme();
        }

        _downloadTheme() {
          const formattedTheme = JSON.stringify(this._theme, null, 4);
          const output = `data:text/json;charset=utf-8,${formattedTheme}`;
          this.$.downloadLink.href = output;
          this.$.downloadLink.click();
        }

        _onColorHover(e) {
          this._emit('color-hover', e.model.item.prop);
        }

        _onListMouseleave(e) {
          this._emit('color-hover', '');
        }

       /**
        * Fired after mouseenter/mouseleave a color field
        * @event color-hover
        * @param {String} detail property name or ''
        */
      }

      window.customElements.define(CycThemeEditor.is, CycThemeEditor);
    }
  </script>
</dom-module>
