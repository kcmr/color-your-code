<link rel="import" href="../../bower_components/polymer/polymer-element.html">
<link rel="import" href="../../bower_components/polymer/lib/elements/dom-repeat.html">

<dom-module id="cyc-theme-editor">
  <template>
    <link rel="stylesheet" href="cyc-theme-editor.css" inline>

    <form class="form" on-change="_enableSubmit" on-reset="_onFormReset" on-submit="_onFormSubmit">
      <fieldset>
        <legend>
          <span>Editor Colors</span>
        </legend>

        <ul class="group-list">
          <template is="dom-repeat" items="[[editorColors]]" id="editorColorsList">
            <li>
              <label class="color-field">
                <span class="label">[[item.name]]</span>
                <span class="input-wrapper">
                  <input type="color" name="[[item.prop]]" value="{{item.value::input}}" data-css-var$="[[item.cssVar]]" on-input="_updateCSSVars">
                </span>
              </label>
            </li>
          </template>
        </ul>
      </fieldset>

      <div class="form-actions">
        <button class="btn btn--secondary" type="reset">It's awful!</button>
        <button class="btn btn--primary" type="submit" disabled="[[!_formChanged]]">Download theme</button>
        <a download="theme.json" id="downloadLink" hidden></a>
      </div>
    </form>
  </template>

  <script>
    class CycThemeEditor extends Polymer.Element {
      static get is() {
        return 'cyc-theme-editor';
      }

      static get properties() {
        return {
          themeType: {
            type: String,
            value: 'dark',
          },
          themeName: {
            type: String,
            value: 'Your theme name',
          },
          editorColors: {
            type: Array,
            value: function() {
              return [{
                name: 'TitleBar background',
                prop: 'titleBar.activeBackground',
                value: '#141820',
                cssVar: '--bg-titleBar',
              }, {
                name: 'ActivityBar background',
                prop: 'activityBar.background',
                value: '#1C212E',
                cssVar: '--bg-activityBar',
              }, {
                name: 'Sidebar background',
                prop: 'sideBar.background',
                value: '#1C212E',
                cssVar: '--bg-sidebar',
              }];
            },
          },
          _formChanged: {
            type: Boolean,
            value: false,
          },
        };
      }

      get _theme() {
        const type = this.themeType;
        const name = this.themeName;
        const colors = {};

        for (const color of this.editorColors) {
          colors[color.prop] = color.value;
        }

        return {type, name, colors};
      }

      _updateCSSVars(e) {
        const {dataset: {cssVar}, value} = e.target;
        document.documentElement.style.setProperty(cssVar, value);
      }

      _onFormReset() {
        this._formChanged = false;
        document.documentElement.removeAttribute('style');
      }

      _onFormSubmit(e) {
        e.preventDefault();
        this._downloadTheme();
      }

      _downloadTheme() {
        const output = 'data:text/json;charset=utf-8,' + JSON.stringify(this._theme, null, 4);
        this.$.downloadLink.href = output;
        this.$.downloadLink.click();
      }

      _enableSubmit() {
        this._formChanged = true;
      }
    }

    window.customElements.define(CycThemeEditor.is, CycThemeEditor);
  </script>
</dom-module>
